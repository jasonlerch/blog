{
  "hash": "bcace38dc22fc94adfcd5c965e480cd9",
  "result": {
    "markdown": "---\ntitle: \"Developmental analyses, part 3\"\ndescription: \"General additive models\"\nauthor: \"Jason Lerch\"\ndate: \"2024/03/19\"\ncategories: [R, longitudinal, RMINC, MRIcrotome]\ndraft: false\n---\n\n\nLoad the data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(\"brain_analysis_data_2024mar18.RData\")\n```\n:::\n\n\nload appropriate libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──\n✔ ggplot2 3.4.2     ✔ purrr   1.0.1\n✔ tibble  3.2.1     ✔ dplyr   1.1.2\n✔ tidyr   1.3.0     ✔ stringr 1.5.0\n✔ readr   2.1.3     ✔ forcats 0.5.2\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\n```\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(mgcv)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: nlme\n\nAttaching package: 'nlme'\n\nThe following object is masked from 'package:dplyr':\n\n    collapse\n\nThis is mgcv 1.8-41. For overview type 'help(\"mgcv-package\")'.\n```\n:::\n\n```{.r .cell-code}\nlibrary(MRIcrotome)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'MRIcrotome'\n\nThe following object is masked from 'package:graphics':\n\n    legend\n```\n:::\n\n```{.r .cell-code}\nlibrary(data.tree)\nlibrary(broom)\nlibrary(emmeans)\nlibrary(RMINC)\nlibrary(splines)\nlibrary(gratia)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'gratia'\n\nThe following object is masked from 'package:MRIcrotome':\n\n    draw\n```\n:::\n:::\n\n\nBuild the hierarchical tree\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhvols <- suppressWarnings(addVolumesToHierarchy(hdefs, structvols))\n```\n:::\n\n\nCreate the list of structures in the hierarchical tree\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbrainstructs <- Traverse(hvols)\n# make it easier to find structures by name\nnames(brainstructs) <- map_chr(brainstructs, ~.x$name)\n```\n:::\n\n\nWe're going to be using general additive models. First a quick look at how they produce different curves from the third order splines used before.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngf %>% mutate(bv=brainstructs[[\"root2\"]]$volumes) %>%\n  ggplot() + aes(x=age, y=bv) + \n  geom_point(alpha=0.2) + \n  geom_smooth(method=\"lm\", formula=y~ns(x, 3)) + \n  geom_smooth(method=\"gam\", formula=y~s(x, bs=\"cs\", k=5), colour=I(\"red\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nSubtle differences, but definitely there.\n\nDefine the models we are going to use. First, the simple model assuming the same slope but different offsets per group.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm1 <- function(y) {\n  gf %>% mutate(y=y$volumes) %>%\n    gam(y ~ sex + Treatment + s(age, bs=\"cs\", k=5), data=.)\n}\n```\n:::\n\n\nLet's see what the output looks like\n\n\n::: {.cell}\n\n```{.r .cell-code}\ns1 <- m1(brainstructs[[\"root2\"]])\nsummary(s1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\ny ~ sex + Treatment + s(age, bs = \"cs\", k = 5)\n\nParametric coefficients:\n             Estimate Std. Error t value Pr(>|t|)    \n(Intercept)   295.925      1.715 172.530   <2e-16 ***\nsexF           -4.831      1.966  -2.458   0.0145 *  \nTreatmentMAR    2.642      2.011   1.314   0.1898    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n         edf Ref.df    F p-value    \ns(age) 3.891      4 2766  <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.971   Deviance explained = 97.2%\nGCV = 313.75  Scale est. = 307.14    n = 327\n```\n:::\n:::\n\n\nThe parametric coefficients are as before. The new bits are in the smooth terms; here saying that the estimated smooths correspond to a spine fit on age with 3.9 degrees of freedom.\n\nThis model isn't quite correct though, as it does not take the mixed effects nature of the data into account. Let's fix that.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# we'll have to first coerce subject_id into a factor\ngf <- gf %>% mutate(subject_id=factor(subject_id))\nm1 <- function(y) {\n  gf %>% mutate(y=y$volumes) %>%\n    gam(y ~ sex + Treatment + s(age, bs=\"cs\", k=8) +\n          s(subject_id, bs=\"re\"), \n        method=\"REML\",\n        data=.)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ns2 <- m1(brainstructs[[\"root2\"]])\nsummary(s2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\ny ~ sex + Treatment + s(age, bs = \"cs\", k = 8) + s(subject_id, \n    bs = \"re\")\n\nParametric coefficients:\n             Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  296.0261     3.6744  80.565   <2e-16 ***\nsexF          -4.0189     4.2403  -0.948    0.344    \nTreatmentMAR   0.4738     4.3095   0.110    0.913    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n                 edf Ref.df        F p-value    \ns(age)         6.516      7 10345.87  <2e-16 ***\ns(subject_id) 45.196     49    16.14  <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.992   Deviance explained = 99.4%\n-REML = 1267.2  Scale est. = 80.952    n = 327\n```\n:::\n:::\n\n\nLet's look at one of the sex dimorphic nuclei\n\n\n::: {.cell}\n\n```{.r .cell-code}\ns3 <- m1(brainstructs[[\"Bed nuclei of the stria terminalis\"]])\nsummary(s3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\ny ~ sex + Treatment + s(age, bs = \"cs\", k = 8) + s(subject_id, \n    bs = \"re\")\n\nParametric coefficients:\n              Estimate Std. Error t value Pr(>|t|)    \n(Intercept)   1.012788   0.013384  75.672   <2e-16 ***\nsexF         -0.033520   0.015425  -2.173   0.0306 *  \nTreatmentMAR -0.001378   0.015690  -0.088   0.9301    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n                 edf Ref.df       F p-value    \ns(age)         6.507      7 818.341  <2e-16 ***\ns(subject_id) 38.504     49   4.568  <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.943   Deviance explained = 95.1%\n-REML = -399.42  Scale est. = 0.0032559  n = 327\n```\n:::\n:::\n\n\nLet's plot it out. This is now a harder model to plot since it doesn't easily get specified into ggplot syntax. So we're better off creating our own data frame for the model predictions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm1g <- function(g1) {\n  emmeans(g1, ~ sex|age, at=list(age=seq(3,65,1))) %>% tidy(conf.int=T)\n}\n```\n:::\n\n\nAnd make a function for plotting a brain structure, as we'll need that again\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotROI <- function(df, fittedModel, brainstructs, roiName, title=NULL, subtitle=NULL) {\n  df %>% \n  mutate(y=brainstructs[[roiName]]$volumes) %>% \n  ggplot() + \n  aes(x=age, y=y, colour=sex, fill=sex) + \n  geom_point(alpha=0.5) + \n  geom_ribbon(data=fittedModel, \n              aes(y=estimate, ymin=conf.low, ymax=conf.high), \n              colour=NA, alpha=0.5) + \n  geom_line(data=fittedModel, aes(y=estimate)) + \n  ylab(bquote(Volume ~ (mm^3))) + \n  ggtitle(ifelse(is.null(title), roiName, title), \n          subtitle = subtitle) +\n  scale_color_brewer(palette = \"Set1\") + \n  scale_fill_brewer(palette = \"Set1\") +\n  theme_minimal()\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ns3Predict <- m1g(s3)\nplotROI(gf, s3Predict, brainstructs,\n        \"Bed nuclei of the stria terminalis\",\n        subtitle = \"Same slope, different offsets\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\nNow let's expand that model to allow for different slopes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm2 <- function(y) {\n  gf %>% mutate(y=y$volumes) %>%\n    gam(y ~ Treatment + \n          s(age, bs=\"cs\", k=8) +\n          s(sex, age, bs=\"sz\", k=8) +\n          s(subject_id, bs=\"re\"), \n        method=\"REML\",\n        data=.)\n}\n```\n:::\n\n\nAnd try the BNST fit\n\n\n::: {.cell}\n\n```{.r .cell-code}\ns4 <- m2(brainstructs[[\"Bed nuclei of the stria terminalis\"]])\nsummary(s4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\ny ~ Treatment + s(age, bs = \"cs\", k = 8) + s(sex, age, bs = \"sz\", \n    k = 8) + s(subject_id, bs = \"re\")\n\nParametric coefficients:\n              Estimate Std. Error t value Pr(>|t|)    \n(Intercept)   0.996274   0.012115  82.236   <2e-16 ***\nTreatmentMAR -0.001653   0.015677  -0.105    0.916    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n                 edf Ref.df       F p-value    \ns(age)         6.507  7.000 816.869  <2e-16 ***\ns(sex,age)     2.001  2.001   2.911  0.0561 .  \ns(subject_id) 38.469 49.000   4.561  <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.943   Deviance explained = 95.1%\n-REML = -394.47  Scale est. = 0.0032558  n = 327\n```\n:::\n:::\n\n\nThis model becomes harder to interpret, as there is no such thing as a main effect of sex anymore. It does hint at the need of separate slopes for sex and age though. Let's plot it out.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ns4Predict <- m1g(s4)\nplotROI(gf, s4Predict, brainstructs,\n        \"Bed nuclei of the stria terminalis\",\n        subtitle = \"Different slope, different offsets\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\nThis plot looks quite similar to what we had before. Any evidence that the more complicated model fits better?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(s3, s4, test=\"Chisq\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table\n\nModel 1: y ~ sex + Treatment + s(age, bs = \"cs\", k = 8) + s(subject_id, \n    bs = \"re\")\nModel 2: y ~ Treatment + s(age, bs = \"cs\", k = 8) + s(sex, age, bs = \"sz\", \n    k = 8) + s(subject_id, bs = \"re\")\n  Resid. Df Resid. Dev      Df  Deviance Pr(>Chi)\n1    270.57    0.90835                           \n2    269.58    0.90519 0.99287 0.0031602   0.3222\n```\n:::\n:::\n\n\nNope. So, BNST conclusion would be evidence (though subtle) for there being different offsets for sex, but no evidence for different offsets and slopes.\n\nLet's expand the model once more to covary for brain volume\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# first we add brain volume to the data frame\ngf <- gf %>% mutate(brainVolume = brainstructs[[\"root2\"]]$volumes)\nm3 <- function(y) {\n  gf %>% mutate(y=y$volumes) %>%\n    gam(y ~ Treatment + brainVolume +\n          s(age, bs=\"cs\", k=8) +\n          s(sex, age, bs=\"sz\", k=8) +\n          s(subject_id, bs=\"re\"), \n        method=\"REML\",\n        data=.)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ns5 <- m3(brainstructs[[\"Bed nuclei of the stria terminalis\"]])\nsummary(s5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\ny ~ Treatment + brainVolume + s(age, bs = \"cs\", k = 8) + s(sex, \n    age, bs = \"sz\", k = 8) + s(subject_id, bs = \"re\")\n\nParametric coefficients:\n               Estimate Std. Error t value Pr(>|t|)    \n(Intercept)   0.0378633  0.0537841   0.704    0.482    \nTreatmentMAR -0.0063100  0.0065784  -0.959    0.338    \nbrainVolume   0.0032653  0.0001825  17.893   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n                 edf Ref.df       F  p-value    \ns(age)         6.206  7.000 110.979  < 2e-16 ***\ns(sex,age)     2.000  2.001   7.376 0.000745 ***\ns(subject_id) 10.493 49.000   0.284 0.089529 .  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.956   Deviance explained = 95.9%\n-REML = -467.91  Scale est. = 0.0024782  n = 327\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ns5Predict <- m1g(s5)\nplotROI(gf, s5Predict, brainstructs,\n        \"Bed nuclei of the stria terminalis\",\n        subtitle = \"Different slope, different offsets, + brain volume\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\nOops - of course the slopes are on a different scale when covarying for brain volume. Let's fix that in a revised version of the plotting function\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotROI2 <- function(df, gamModel, fittedModel, brainstructs, roiName, title=NULL, subtitle=NULL) {\n  df %>% \n  mutate(y=predict(gamModel, \n                   newdata = df %>% mutate(brainVolume=mean(brainVolume))) + \n           residuals(gamModel)) %>% \n  ggplot() + \n    aes(x=age, y=y, colour=sex, fill=sex) + \n    geom_point(alpha=0.5) + \n    geom_ribbon(data=fittedModel, \n                aes(y=estimate, ymin=conf.low, ymax=conf.high), \n                colour=NA, alpha=0.5) + \n    geom_line(data=fittedModel, aes(y=estimate)) + \n    ylab(bquote(Volume ~ (mm^3))) + \n    labs(title=ifelse(is.null(title), roiName, title), \n         subtitle = subtitle,\n         caption = paste(\"Evaluated at brain volume =\", \n                         round(mean(df$brainVolume)))) +\n    scale_color_brewer(palette = \"Set1\") + \n    scale_fill_brewer(palette = \"Set1\") +\n    theme_minimal()\n}                                     \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplotROI2(gf, s5, s5Predict, brainstructsBV,\n        \"Bed nuclei of the stria terminalis\",\n        subtitle = \"Different slope, different offsets, + brain volume\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\nLet's go back to the models without controlling for brain volume for a moment. How do we interpret the effects?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(s3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\ny ~ sex + Treatment + s(age, bs = \"cs\", k = 8) + s(subject_id, \n    bs = \"re\")\n\nParametric coefficients:\n              Estimate Std. Error t value Pr(>|t|)    \n(Intercept)   1.012788   0.013384  75.672   <2e-16 ***\nsexF         -0.033520   0.015425  -2.173   0.0306 *  \nTreatmentMAR -0.001378   0.015690  -0.088   0.9301    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n                 edf Ref.df       F p-value    \ns(age)         6.507      7 818.341  <2e-16 ***\ns(subject_id) 38.504     49   4.568  <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.943   Deviance explained = 95.1%\n-REML = -399.42  Scale est. = 0.0032559  n = 327\n```\n:::\n:::\n\n\nThis model (s3) has a spline for age and main effects for treatment and sex. Reference sex is male (we usually switch that, but that's just convention), so the value is telling us that female mice have a smaller BNST. This is vaguely significant. This model is quite similar to either straight line models or the third order spline models we fitted earlier.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(s4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\ny ~ Treatment + s(age, bs = \"cs\", k = 8) + s(sex, age, bs = \"sz\", \n    k = 8) + s(subject_id, bs = \"re\")\n\nParametric coefficients:\n              Estimate Std. Error t value Pr(>|t|)    \n(Intercept)   0.996274   0.012115  82.236   <2e-16 ***\nTreatmentMAR -0.001653   0.015677  -0.105    0.916    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n                 edf Ref.df       F p-value    \ns(age)         6.507  7.000 816.869  <2e-16 ***\ns(sex,age)     2.001  2.001   2.911  0.0561 .  \ns(subject_id) 38.469 49.000   4.561  <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.943   Deviance explained = 95.1%\n-REML = -394.47  Scale est. = 0.0032558  n = 327\n```\n:::\n:::\n\n\nNow we've removed the main effect term for sex and instead added a spline term for sex and age. There's a lot of info about different spline choices out there, but the two we use here are `s(age, bs=\"cs\", k=8)`, which tells the GAM to allow a cubic spline (that's the cs) on age with a maximum of 8 degrees of freedom. If you look at the output, it tells us that it found a effective degrees of freedom (edf) of 6.5 optimal. The second spline term is `s(sex,age, bs=\"sz\", k=8)`. This is a sum to zero (sz) constraint that fits a separate smooth on age for each level of sex. Now, since we already fit a smoothing term for age, this here can be interpreted as deviations from the main fit line. The fact that we have 2 effective degrees of freedom that are hovering at p=0.05 tells us that there is some evidence deviations from the main age curve by sex. The last smooth term on subject id is the equivalent of adding a random effect to lmer.\n\nIt can help to investigate the model:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(s4)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-25-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-25-3.png){width=672}\n:::\n:::\n\n\nagain showing the roughly equal deviation from the main age curve. The earlier anova comparing the two models also showed that it's of no great benefit to add the more complicated smoothing term.\n\nFor completeness sake, what about treatment?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm4 <- function(y) {\n  gf %>% mutate(y=y$volumes) %>%\n    gam(y ~ s(age, bs=\"cs\", k=8) +\n          s(sex, age, bs=\"sz\", k=8) +\n          s(Treatment, age, bs=\"sz\", k=8) + \n          s(sex,Treatment, age, bs=\"sz\", k=8) +\n          s(subject_id, bs=\"re\"), \n        method=\"REML\",\n        data=.)\n}\n```\n:::\n\n\nThis model now fits separate sum to zero splines for sex, treatment, and the three way treatment by sex by age terms.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ns6 <- m4(brainstructs[[\"Bed nuclei of the stria terminalis\"]])\nsummary(s6)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\ny ~ s(age, bs = \"cs\", k = 8) + s(sex, age, bs = \"sz\", k = 8) + \n    s(Treatment, age, bs = \"sz\", k = 8) + s(sex, Treatment, age, \n    bs = \"sz\", k = 8) + s(subject_id, bs = \"re\")\n\nParametric coefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept) 0.996820   0.007828   127.3   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n                        edf Ref.df       F p-value    \ns(age)                6.513  7.000 801.958  <2e-16 ***\ns(sex,age)            2.000  2.000   1.778   0.171    \ns(Treatment,age)      3.240  3.676   1.102   0.244    \ns(sex,Treatment,age)  2.000  2.000   1.562   0.212    \ns(subject_id)        37.609 48.000   4.518  <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.944   Deviance explained = 95.3%\n-REML = -383.41  Scale est. = 0.003201  n = 327\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(s6)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-28-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-28-3.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-28-4.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-28-5.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ns6predict <- m1g(s6)\nplotROI(gf, s6predict, brainstructs, \"Bed nuclei of the stria terminalis\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-29-1.png){width=672}\n:::\n:::\n\n\nThe plot with the most complex model still looks quite similar\n\n\n::: {.cell}\n\n```{.r .cell-code}\ns6predict %>% filter(age==35)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 9\n  sex     age estimate std.error    df conf.low conf.high statistic   p.value\n  <chr> <dbl>    <dbl>     <dbl> <dbl>    <dbl>     <dbl>     <dbl>     <dbl>\n1 M        35     1.16    0.0133  275.     1.13      1.18      87.2 3.87e-202\n2 F        35     1.12    0.0144  275.     1.10      1.15      78.1 1.56e-189\n```\n:::\n\n```{.r .cell-code}\ns4Predict %>% filter(age==35)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 9\n  sex     age estimate std.error    df conf.low conf.high statistic   p.value\n  <chr> <dbl>    <dbl>     <dbl> <dbl>    <dbl>     <dbl>     <dbl>     <dbl>\n1 M        35     1.16    0.0133  278.     1.13      1.18      86.9 1.71e-203\n2 F        35     1.12    0.0140  278.     1.09      1.14      79.5 2.95e-193\n```\n:::\n:::\n\n\nComparing the output of the two models also shows pretty similar estimates of sex at (the randomly chosen) age of 35 days.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npairs(emmeans(s6, ~sex|age, at=list(age=35)))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nage = 35:\n contrast estimate     SE  df t.ratio p.value\n M - F      0.0316 0.0169 275   1.871  0.0624\n\nResults are averaged over the levels of: Treatment \n```\n:::\n\n```{.r .cell-code}\npairs(emmeans(s4, ~sex|age, at=list(age=35)))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nage = 35:\n contrast estimate     SE  df t.ratio p.value\n M - F      0.0398 0.0165 278   2.406  0.0168\n\nResults are averaged over the levels of: Treatment \n```\n:::\n:::\n\n\nAllowing for separate treatment terms slightly dampens the age effect.\n\nLet's investigate what these models do using some artificial data. I'm going to simulate a simple dataset shaped vagued like the developmental one here (though treating it as cross-sectional for simplicity's sake). First, what happens if there is only an offset but the slopes are constant?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nx1 <- 0.1\nx2 <- 0.005\nset.seed(1234)\nd1 <- data.frame(age=rep(unique(gf$age), 10)) %>% \n  mutate(volume = rnorm(80) + age*x1 + (age^2)*x2, group=\"g1\") %>% \n  rbind (data.frame(age=rep(unique(gf$age), 10)) %>% \n           mutate(volume = rnorm(80, 0.5) + age*x1 + (age^2)*x2, group=\"g2\")) %>% \n  mutate(group=factor(group))\n```\n:::\n\n\nHere we have a normally distributed intercept, with the first group having a mean of 0 and the second a mean 0.5\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(d1) + aes(x=age, y=volume, colour=group) + \n  geom_point() + geom_smooth(method=\"gam\", formula=y~s(x, bs=\"cs\", k=8)) + \n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-33-1.png){width=672}\n:::\n:::\n\n\nLet's model it\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntM <- gam(volume ~ s(age, bs=\"cs\", k=8) + s(group, age, bs=\"sz\", k=8), data=d1)\nsummary(tM)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\nvolume ~ s(age, bs = \"cs\", k = 8) + s(group, age, bs = \"sz\", \n    k = 8)\n\nParametric coefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  6.30589    0.07488   84.21   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n               edf Ref.df       F  p-value    \ns(age)       3.046      7 1867.38  < 2e-16 ***\ns(group,age) 2.000      2   14.81 1.59e-06 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.988   Deviance explained = 98.8%\nGCV = 0.9324  Scale est. = 0.89717   n = 160\n```\n:::\n:::\n\n\nSo an edf of 2 that does come out as significant because of the offset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemmeans(tM, ~group|age, at=list(age=c(3,65))) %>% pairs\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nage =  3:\n contrast estimate    SE  df t.ratio p.value\n g1 - g2    -0.935 0.202 154  -4.631  <.0001\n\nage = 65:\n contrast estimate    SE  df t.ratio p.value\n g1 - g2    -0.468 0.370 154  -1.268  0.2069\n```\n:::\n:::\n\n\nCapturing that with a simpler model\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntM2 <- gam(volume ~ group + s(age, bs=\"cs\", k=8), data=d1)\nsummary(tM2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\nvolume ~ group + s(age, bs = \"cs\", k = 8)\n\nParametric coefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)   5.9050     0.1059  55.772  < 2e-16 ***\ngroupg2       0.8017     0.1497   5.354 3.04e-07 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n         edf Ref.df    F p-value    \ns(age) 3.079      7 1869  <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.988   Deviance explained = 98.8%\nGCV = 0.9262  Scale est. = 0.8968    n = 160\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nemmeans(tM2, ~group|age, at=list(age=c(3,65))) %>% pairs\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nage =  3:\n contrast estimate   SE  df t.ratio p.value\n g1 - g2    -0.802 0.15 155  -5.354  <.0001\n\nage = 65:\n contrast estimate   SE  df t.ratio p.value\n g1 - g2    -0.802 0.15 155  -5.354  <.0001\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(tM2, tM, test=\"Chisq\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table\n\nModel 1: volume ~ group + s(age, bs = \"cs\", k = 8)\nModel 2: volume ~ s(age, bs = \"cs\", k = 8) + s(group, age, bs = \"sz\", \n    k = 8)\n  Resid. Df Resid. Dev      Df Deviance Pr(>Chi)\n1    154.39     138.93                          \n2    153.43     138.12 0.96311  0.80919   0.3297\n```\n:::\n:::\n\n\nSo the simpler model is clearly easier to interpret, and there's no benefit in fitting the more complicated model. But the more complicated model does catch a difference in the sz fit even if there's only variation in intercept.\n\nNow let's model a change in slope\n\n\n::: {.cell}\n\n```{.r .cell-code}\nx1 <- 0.1\nx1.2 <- 0.075\nx2 <- 0.005\nset.seed(1234)\nd1 <- data.frame(age=rep(unique(gf$age), 10)) %>% \n  mutate(volume = rnorm(80) + age*x1 + (age^2)*x2, group=\"g1\") %>% \n  rbind (data.frame(age=rep(unique(gf$age), 10)) %>% \n           mutate(volume = rnorm(80) + age*x1.2 + (age^2)*x2, group=\"g2\")) %>% \n  mutate(group=factor(group))\n\nggplot(d1) + aes(x=age, y=volume, colour=group) + \n  geom_point() + geom_smooth(method=\"gam\", formula=y~s(x, bs=\"cs\", k=8)) + \n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-39-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntM <- gam(volume ~ s(age, bs=\"cs\", k=8) + s(group, age, bs=\"sz\", k=8), data=d1)\nsummary(tM)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\nvolume ~ s(age, bs = \"cs\", k = 8) + s(group, age, bs = \"sz\", \n    k = 8)\n\nParametric coefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  5.79651    0.07487   77.43   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n               edf Ref.df       F  p-value    \ns(age)       3.112      7 1765.55  < 2e-16 ***\ns(group,age) 2.000      2   10.13 7.38e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.987   Deviance explained = 98.8%\nGCV = 0.93239  Scale est. = 0.89677   n = 160\n```\n:::\n\n```{.r .cell-code}\ntM2 <- gam(volume ~ group + s(age, bs=\"cs\", k=8), data=d1)\nsummary(tM2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\nvolume ~ group + s(age, bs = \"cs\", k = 8)\n\nParametric coefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)   5.9050     0.1116  52.910   <2e-16 ***\ngroupg2      -0.2170     0.1578  -1.375    0.171    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n         edf Ref.df    F p-value    \ns(age) 3.047      7 1588  <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.986   Deviance explained = 98.6%\nGCV = 1.0289  Scale est. = 0.99645   n = 160\n```\n:::\n\n```{.r .cell-code}\nemmeans(tM, ~group|age, at=list(age=c(3,65))) %>% pairs\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nage =  3:\n contrast estimate    SE  df t.ratio p.value\n g1 - g2     -0.36 0.202 154  -1.785  0.0763\n\nage = 65:\n contrast estimate    SE  df t.ratio p.value\n g1 - g2      1.66 0.370 154   4.483  <.0001\n```\n:::\n\n```{.r .cell-code}\nemmeans(tM2, ~group|age, at=list(age=c(3,65))) %>% pairs\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nage =  3:\n contrast estimate    SE  df t.ratio p.value\n g1 - g2     0.217 0.158 155   1.375  0.1711\n\nage = 65:\n contrast estimate    SE  df t.ratio p.value\n g1 - g2     0.217 0.158 155   1.375  0.1711\n```\n:::\n\n```{.r .cell-code}\nanova(tM2, tM, test=\"Chisq\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table\n\nModel 1: volume ~ group + s(age, bs = \"cs\", k = 8)\nModel 2: volume ~ s(age, bs = \"cs\", k = 8) + s(group, age, bs = \"sz\", \n    k = 8)\n  Resid. Df Resid. Dev     Df Deviance  Pr(>Chi)    \n1    154.43      154.4                              \n2    153.36      138.0 1.0714     16.4 2.205e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\nIn this case the more complex model clearly fits better, and finds significance where it should. The simpler model fails to distinguish the groups.\n\nLet's run it on all models. But first a small rewrite of our model to spit out which structure is being fit, as that will help identify where any fitting errors are occurring.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm4wprint <- function(y, verbose=TRUE) {  \n  if (verbose) {\n    cat(y$name, \"\\n\")\n  }\n  gf %>% mutate(y=y$volumes) %>%\n    gam(y ~ s(age, bs=\"cs\", k=8) +\n          s(sex, age, bs=\"sz\", k=8) +\n          s(Treatment, age, bs=\"sz\", k=8) + \n          s(sex,Treatment, age, bs=\"sz\", k=8) +\n          s(subject_id, bs=\"re\"), \n        method=\"REML\",\n        data=.)\n}\n```\n:::\n\n::: {.cell hash='index_cache/html/unnamed-chunk-42_4813bbf6ba2c95a9845a5d6ab399e285'}\n\n```{.r .cell-code}\ncomplexModel <- map(brainstructs, m4wprint)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nroot2 \nBasic cell groups and regions \nCerebrum \nCerebral cortex \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nCortical subplate \nCortical subplate-other \nleft Cortical subplate-other \nright Cortical subplate-other \nClaustrum \nClaustrum-other \nleft Claustrum-other \nright Claustrum-other \nClaustrum: dorsal part \nleft Claustrum: dorsal part \nright Claustrum: dorsal part \nClaustrum: ventral part \nleft Claustrum: ventral part \nright Claustrum: ventral part \nEndopiriform nucleus \nEndopiriform nucleus, dorsal part \nDorsal nucleus of the endopiriform \nleft Dorsal nucleus of the endopiriform \nright Dorsal nucleus of the endopiriform \nIntermediate nucleus of the endopiriform claustrum \nleft Intermediate nucleus of the endopiriform claustrum \nright Intermediate nucleus of the endopiriform claustrum \nEndopiriform nucleus, ventral part \nleft Endopiriform nucleus, ventral part \nright Endopiriform nucleus, ventral part \nCortical plate \nOlfactory areas \nOlfactory areas-other \nleft Olfactory areas-other \nright Olfactory areas-other \nPostpiriform transition area \nleft Postpiriform transition area \nright Postpiriform transition area \nPiriform area \nCortex-amygdala transition zones \nleft Cortex-amygdala transition zones \nright Cortex-amygdala transition zones \nPiriform cortex \nleft Piriform cortex \nright Piriform cortex \nTaenia tecta \nTaenia tecta, dorsal part \nleft Taenia tecta, dorsal part \nright Taenia tecta, dorsal part \nTaenia tecta, ventral part \nleft Taenia tecta, ventral part \nright Taenia tecta, ventral part \nCortical amygdalar area \nCortical amygdalar area, posterior part \nCortical amygdalar area, posterior part, lateral zone \nleft Cortical amygdalar area, posterior part, lateral zone \nright Cortical amygdalar area, posterior part, lateral zone \nCortical amygdalar area, posterior part, medial zone \nleft Cortical amygdalar area, posterior part, medial zone \nright Cortical amygdalar area, posterior part, medial zone \nPiriform-amygdalar area \nleft Piriform-amygdalar area \nright Piriform-amygdalar area \nMain olfactory bulb \nMain olfactory bulb, glomerular layer \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nleft Main olfactory bulb, glomerular layer \nright Main olfactory bulb, glomerular layer \nMain olfactory bulb, outer plexiform layer \nleft Main olfactory bulb, outer plexiform layer \nright Main olfactory bulb, outer plexiform layer \nMain olfactory bulb, mitral layer \nleft Main olfactory bulb, mitral layer \nright Main olfactory bulb, mitral layer \nMain olfactory bulb, inner plexiform layer \nleft Main olfactory bulb, inner plexiform layer \nright Main olfactory bulb, inner plexiform layer \nMain olfactory bulb, granule layer \nleft Main olfactory bulb, granule layer \nright Main olfactory bulb, granule layer \nAccessory olfactory bulb \nAccessory olfactory bulb, glomerular layer \nleft Accessory olfactory bulb, glomerular layer \nright Accessory olfactory bulb, glomerular layer \nAccessory olfactory bulb, granular layer \nleft Accessory olfactory bulb, granular layer \nright Accessory olfactory bulb, granular layer \nAnterior olfactory nucleus \nleft Anterior olfactory nucleus \nright Anterior olfactory nucleus \nHippocampal formation \nRetrohippocampal region \nSubiculum \npre-para subiculum \nleft pre-para subiculum \nright pre-para subiculum \nsubiculum \nleft subiculum \nright subiculum \nEntorhinal area \nEntorhinal area, medial part, dorsal zone \nleft Entorhinal area, medial part, dorsal zone \nright Entorhinal area, medial part, dorsal zone \nEntorhinal area, lateral part \nDorsal intermediate entorhinal cortex \nleft Dorsal intermediate entorhinal cortex \nright Dorsal intermediate entorhinal cortex \nDorsolateral entorhinal cortex \nleft Dorsolateral entorhinal cortex \nright Dorsolateral entorhinal cortex \nVentral intermediate entorhinal cortex \nleft Ventral intermediate entorhinal cortex \nright Ventral intermediate entorhinal cortex \nEntorhinal area, medial part, ventral zone \nleft Entorhinal area, medial part, ventral zone \nright Entorhinal area, medial part, ventral zone \nHippocampal region \nAmmon's horn \nField CA1 \nField CA1, stratum oriens \nleft Field CA1, stratum oriens \nright Field CA1, stratum oriens \nField CA1, stratum lacunosum-moleculare \nleft Field CA1, stratum lacunosum-moleculare \nright Field CA1, stratum lacunosum-moleculare \nField CA1, stratum radiatum \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nleft Field CA1, stratum radiatum \nright Field CA1, stratum radiatum \nField CA1, pyramidal layer \nleft Field CA1, pyramidal layer \nright Field CA1, pyramidal layer \nField CA2 \nField CA2, pyramidal layer \nleft Field CA2, pyramidal layer \nright Field CA2, pyramidal layer \nField CA2, stratum oriens \nleft Field CA2, stratum oriens \nright Field CA2, stratum oriens \nField CA2, stratum radiatum \nleft Field CA2, stratum radiatum \nright Field CA2, stratum radiatum \nField CA3 \nField CA3, pyramidal layer \nCA3Py Inner \nleft CA3Py Inner \nright CA3Py Inner \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nCA3Py Outer \nleft CA3Py Outer \nright CA3Py Outer \nField CA3, stratum oriens \nleft Field CA3, stratum oriens \nright Field CA3, stratum oriens \nField CA3, stratum radiatum \nleft Field CA3, stratum radiatum \nright Field CA3, stratum radiatum \nField CA3, stratum lucidum \nleft Field CA3, stratum lucidum \nright Field CA3, stratum lucidum \nDentate gyrus \nDentate gyrus, molecular layer \nleft Dentate gyrus, molecular layer \nright Dentate gyrus, molecular layer \nDentate gyrus, granule cell layer \nGrDG \nleft GrDG \nright GrDG \nPoDG \nleft PoDG \nright PoDG \nIsocortex \nAnterior cingulate area \nAnterior cingulate area, ventral part \nCingulate cortex: area 24a \nleft Cingulate cortex: area 24a \nright Cingulate cortex: area 24a \nCingulate cortex: area 24a' \nleft Cingulate cortex: area 24a' \nright Cingulate cortex: area 24a' \nAnterior cingulate area, dorsal part \nCingulate cortex: area 24b \nleft Cingulate cortex: area 24b \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nright Cingulate cortex: area 24b \nCingulate cortex: area 24b' \nleft Cingulate cortex: area 24b' \nright Cingulate cortex: area 24b' \nInfralimbic area \nleft Infralimbic area \nright Infralimbic area \nRetrosplenial area \nRetrosplenial area, ventral part \nCingulate cortex: area 29a \nleft Cingulate cortex: area 29a \nright Cingulate cortex: area 29a \nCingulate cortex: area 29b \nleft Cingulate cortex: area 29b \nright Cingulate cortex: area 29b \nCingulate cortex: area 29c \nleft Cingulate cortex: area 29c \nright Cingulate cortex: area 29c \nRetrosplenial area, dorsal part \nleft Retrosplenial area, dorsal part \nright Retrosplenial area, dorsal part \nPrelimbic area \nleft Prelimbic area \nright Prelimbic area \nAuditory areas \nPrimary auditory area \nleft Primary auditory area \nright Primary auditory area \nDorsal auditory area \nleft Dorsal auditory area \nright Dorsal auditory area \nVentral auditory area \nleft Ventral auditory area \nright Ventral auditory area \nAgranular insular area \nAgranular insular area, dorsal part \nleft Agranular insular area, dorsal part \nright Agranular insular area, dorsal part \nEctorhinal area \nEctorhinal cortex \nleft Ectorhinal cortex \nright Ectorhinal cortex \nInsular region: not subdivided \nleft Insular region: not subdivided \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nright Insular region: not subdivided \nSomatomotor areas \nPrimary motor area \nFrontal cortex: area 3 \nleft Frontal cortex: area 3 \nright Frontal cortex: area 3 \nPrimary motor cortex \nleft Primary motor cortex \nright Primary motor cortex \nSecondary motor area \nleft Secondary motor area \nright Secondary motor area \nFrontal pole, cerebral cortex \nleft Frontal pole, cerebral cortex \nright Frontal pole, cerebral cortex \nOrbital area \nOrbital area, lateral part \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nleft Orbital area, lateral part \nright Orbital area, lateral part \nOrbital area, medial part \nleft Orbital area, medial part \nright Orbital area, medial part \nOrbital area, ventrolateral part \nleft Orbital area, ventrolateral part \nright Orbital area, ventrolateral part \nPosterior parietal association areas \nLateral parietal association cortex \nleft Lateral parietal association cortex \nright Lateral parietal association cortex \nMedial parietal association cortex \nleft Medial parietal association cortex \nright Medial parietal association cortex \nParietal cortex: posterior area: rostral part \nleft Parietal cortex: posterior area: rostral part \nright Parietal cortex: posterior area: rostral part \nSecondary visual cortex: mediomedial area \nleft Secondary visual cortex: mediomedial area \nright Secondary visual cortex: mediomedial area \nPerirhinal area \nleft Perirhinal area \nright Perirhinal area \nSomatosensory areas \nPrimary somatosensory area \nPrimary somatosensory area-other \nleft Primary somatosensory area-other \nright Primary somatosensory area-other \nPrimary somatosensory area, barrel field \nleft Primary somatosensory area, barrel field \nright Primary somatosensory area, barrel field \nPrimary somatosensory area, trunk \nPrimary somatosensory cortex: dysgranular zone \nleft Primary somatosensory cortex: dysgranular zone \nright Primary somatosensory cortex: dysgranular zone \nPrimary somatosensory cortex: shoulder region \nleft Primary somatosensory cortex: shoulder region \nright Primary somatosensory cortex: shoulder region \nPrimary somatosensory cortex: trunk region \nleft Primary somatosensory cortex: trunk region \nright Primary somatosensory cortex: trunk region \nPrimary somatosensory area, upper limb \nleft Primary somatosensory area, upper limb \nright Primary somatosensory area, upper limb \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nPrimary somatosensory area, lower limb \nleft Primary somatosensory area, lower limb \nright Primary somatosensory area, lower limb \nPrimary somatosensory area, mouth \nleft Primary somatosensory area, mouth \nright Primary somatosensory area, mouth \nPrimary somatosensory area, nose \nleft Primary somatosensory area, nose \nright Primary somatosensory area, nose \nSupplemental somatosensory area \nleft Supplemental somatosensory area \nright Supplemental somatosensory area \nTemporal association areas \nleft Temporal association areas \nright Temporal association areas \nVisual areas \nPrimary visual area \nleft Primary visual area \nright Primary visual area \nLateral visual area \nleft Lateral visual area \nright Lateral visual area \nposteromedial visual area \nleft posteromedial visual area \nright posteromedial visual area \nAnterolateral visual area \nleft Anterolateral visual area \nright Anterolateral visual area \nAnteromedial visual area \nleft Anteromedial visual area \nright Anteromedial visual area \nCerebral nuclei \nPallidum \nPallidum, ventral region \nleft Pallidum, ventral region \nright Pallidum, ventral region \nPallidum, caudal region \nBed nuclei of the stria terminalis \nleft Bed nuclei of the stria terminalis \nright Bed nuclei of the stria terminalis \nPallidum, dorsal region \nleft Pallidum, dorsal region \nright Pallidum, dorsal region \nPallidum, medial region \nMedial septal complex \nleft Medial septal complex \nright Medial septal complex \nStriatum \nStriatum ventral region \nFundus of striatum \nleft Fundus of striatum \nright Fundus of striatum \nNucleus accumbens \nleft Nucleus accumbens \nright Nucleus accumbens \nOlfactory tubercle \nleft Olfactory tubercle \nright Olfactory tubercle \nLateral septal complex \nleft Lateral septal complex \nright Lateral septal complex \nStriatum dorsal region \nCaudoputamen \nleft Caudoputamen \nright Caudoputamen \nStriatum-like amygdalar nuclei \nMedial amygdalar nucleus \nleft Medial amygdalar nucleus \nright Medial amygdalar nucleus \nBrain stem \nMidbrain \nMidbrain, sensory related \nInferior colliculus \nleft Inferior colliculus \nright Inferior colliculus \nSuperior colliculus, sensory related \nleft Superior colliculus, sensory related \nright Superior colliculus, sensory related \nMidbrain, behavioral state related \nMidbrain raphe nuclei \nInterpeduncular nucleus \nMidbrain-other \nMidbrain, motor related \nPeriaqueductal gray \nHindbrain \nMedulla \nMedulla, sensory related \nDorsal column nuclei \nCuneate nucleus \nleft Cuneate nucleus \nright Cuneate nucleus \nMedulla, motor related \nInferior olivary complex \nleft Inferior olivary complex \nright Inferior olivary complex \nMedulla-other \nPons \nPons-other \nPons, behavioral state related \nPontine reticular nucleus \nleft Pontine reticular nucleus \nright Pontine reticular nucleus \nPons, sensory related \nSuperior olivary complex \nleft Superior olivary complex \nright Superior olivary complex \nInterbrain \nHypothalamus \nHypothalamus-other \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nleft Hypothalamus-other \nright Hypothalamus-other \nHypothalamic medial zone \nMammillary body \nleft Mammillary body \nright Mammillary body \nMedial preoptic nucleus \nleft Medial preoptic nucleus \nright Medial preoptic nucleus \nThalamus \nleft Thalamus \nright Thalamus \nCerebellum \nCerebellar cortex \nVermal regions \nLingula (I) \nCentral lobule \nCulmen \nCulmen-other \nLobules IV-V \nleft Lobules IV-V \nright Lobules IV-V \nDeclive (VI) \nFolium-tuber vermis (VII) \nPyramus (VIII) \nUvula (IX) \nNodulus (X) \nHemispheric regions \nSimple lobule \nleft Simple lobule \nright Simple lobule \nAnsiform lobule \nCrus 1 \nleft Crus 1 \nright Crus 1 \nCrus 2 \nleft Crus 2 \nright Crus 2 \nParamedian lobule \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nleft Paramedian lobule \nright Paramedian lobule \nCopula pyramidis \nleft Copula pyramidis \nright Copula pyramidis \nFlocculus \nleft Flocculus \nright Flocculus \nParaflocculus \nleft Paraflocculus \nright Paraflocculus \nCerebellar nuclei \nDentate nucleus \nleft Dentate nucleus \nright Dentate nucleus \nInterposed nucleus \nleft Interposed nucleus \nright Interposed nucleus \nFastigial nucleus \nleft Fastigial nucleus \nright Fastigial nucleus \nfiber tracts \ncranial nerves \nolfactory nerve \nanterior commissure, olfactory limb \nleft anterior commissure, olfactory limb \nright anterior commissure, olfactory limb \nlateral olfactory tract, general \nleft lateral olfactory tract, general \nright lateral olfactory tract, general \nfacial nerve \nleft facial nerve \nright facial nerve \ndorsal roots \ncervicothalamic tract \nmedial lemniscus \nleft medial lemniscus \nright medial lemniscus \noptic nerve \noptic tract \nleft optic tract \nright optic tract \noculomotor nerve \nposterior commissure \nmedial forebrain bundle system \ncerebrum related \nanterior commissure, temporal limb \nleft anterior commissure, temporal limb \nright anterior commissure, temporal limb \nfornix system \nfimbria \nleft fimbria \nright fimbria \ndorsal fornix \nleft dorsal fornix \nright dorsal fornix \nstria terminalis \nleft stria terminalis \nright stria terminalis \ncingulum bundle \nleft cingulum bundle \nright cingulum bundle \nhypothalamus related \nepithalamus related \nfasciculus retroflexus \nleft fasciculus retroflexus \nright fasciculus retroflexus \nhabenular commissure \nleft habenular commissure \nright habenular commissure \nstria medullaris \nleft stria medullaris \nright stria medullaris \nmammillary related \nmammilothalmic tract \nleft mammilothalmic tract \nright mammilothalmic tract \ncerebellum related fiber tracts \ncerebellar peduncles \ninferior cerebellar peduncle \nleft inferior cerebellar peduncle \nright inferior cerebellar peduncle \nmiddle cerebellar peduncle \nleft middle cerebellar peduncle \nright middle cerebellar peduncle \nsuperior cerebelar peduncles \nleft superior cerebelar peduncles \nright superior cerebelar peduncles \narbor vitae \ntrunk of arbor vita \nlobule 1-2 white matter \nlobule 3 white matter \ntrunk of lobules 1-3 white matter \nlobules 4-5 white matter \nlobules 6-7 white matter \nlobule 8 white matter \ntrunk of lobules 6-8 white matter \nlobule 9 white matter \nlobule 10 white matter \nanterior lobule white matter \nleft anterior lobule white matter \nright anterior lobule white matter \nsimple lobule white matter \nleft simple lobule white matter \nright simple lobule white matter \ncrus 1 white matter \nleft crus 1 white matter \nright crus 1 white matter \ntrunk of simple and crus 1 white matter \nleft trunk of simple and crus 1 white matter \nright trunk of simple and crus 1 white matter \ncrus 2 white matter \nleft crus 2 white matter \nright crus 2 white matter \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nparamedian lobule \nleft paramedian lobule \nright paramedian lobule \ntrunk of crus 2 and paramedian white matter \nleft trunk of crus 2 and paramedian white matter \nright trunk of crus 2 and paramedian white matter \ncopula white matter \nleft copula white matter \nright copula white matter \nparaflocculus white matter \nleft paraflocculus white matter \nright paraflocculus white matter \nflocculus white matter \nleft flocculus white matter \nright flocculus white matter \nlateral forebrain bundle system \ncorticospinal tract \ncerebal peduncle \nleft cerebal peduncle \nright cerebal peduncle \ncorticospinal tract-other \nleft corticospinal tract-other \nright corticospinal tract-other \ninternal capsule \nleft internal capsule \nright internal capsule \ncorpus callosum \nleft corpus callosum \nright corpus callosum \nextrapyramidal fiber systems \nrubrospinal tract \nventral tegmental decussation \nventricular systems \ncerebral aqueduct \nfourth ventricle \nlateral ventricle \nlateral ventricle-other \nleft lateral ventricle-other \nright lateral ventricle-other \nsubependymal zone \nleft subependymal zone \nright subependymal zone \nthird ventricle \n```\n:::\n:::\n\n\nThere are a few areas that warn with the following message: \"Fitting terminated with step failure - check results carefully\". Let's look at a few of them:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotROI(gf, m1g(complexModel[[\"Taenia tecta\"]]), brainstructs, \"Taenia tecta\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-43-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplotROI(gf, m1g(complexModel[[\"right crus 2 white matter\"]]), brainstructs, \"right crus 2 white matter\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-43-2.png){width=672}\n:::\n:::\n\n\nVisually the fit looks good in both cases. And in both cases we can see outliers that are likely the result of poor segmentations.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(complexModel[[\"Taenia tecta\"]])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\ny ~ s(age, bs = \"cs\", k = 8) + s(sex, age, bs = \"sz\", k = 8) + \n    s(Treatment, age, bs = \"sz\", k = 8) + s(sex, Treatment, age, \n    bs = \"sz\", k = 8) + s(subject_id, bs = \"re\")\n\nParametric coefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept) 0.667016   0.005469     122   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n                        edf Ref.df        F p-value    \ns(age)                5.037  7.000 1081.674  <2e-16 ***\ns(sex,age)            2.000  2.000    1.733  0.1785    \ns(Treatment,age)      2.965  3.365    1.197  0.3314    \ns(sex,Treatment,age)  2.000  2.000    2.534  0.0811 .  \ns(subject_id)        30.008 48.000    1.858  <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.959   Deviance explained = 96.4%\n-REML = -421.68  Scale est. = 0.0029228  n = 327\n```\n:::\n\n```{.r .cell-code}\nsummary(complexModel[[\"right crus 2 white matter\"]])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\ny ~ s(age, bs = \"cs\", k = 8) + s(sex, age, bs = \"sz\", k = 8) + \n    s(Treatment, age, bs = \"sz\", k = 8) + s(sex, Treatment, age, \n    bs = \"sz\", k = 8) + s(subject_id, bs = \"re\")\n\nParametric coefficients:\n             Estimate Std. Error t value Pr(>|t|)    \n(Intercept) 0.0227090  0.0007863   28.88   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n                        edf Ref.df       F p-value    \ns(age)                4.129  7.000 230.029  <2e-16 ***\ns(sex,age)            2.001  2.001   0.545  0.5806    \ns(Treatment,age)      3.387  3.841   3.075  0.0264 *  \ns(sex,Treatment,age)  2.661  3.015   0.499  0.6885    \ns(subject_id)        16.584 48.000   0.554  0.0125 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.844   Deviance explained = 85.7%\n-REML = -957.03  Scale est. = 0.00011433  n = 327\n```\n:::\n:::\n\n\nIn both cases the model terms looks reasonable too. So I think for now we can keep these models even with that warning. It might be worth including an outlier rejection step ahead of the fitting though. Leave that for the future.\n\nLet's fit a simpler model too - allowing separate treatment and sex terms, but not treatment by sex interaction\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm5 <- function(y) {\n    gf %>% mutate(y=y$volumes) %>%\n    gam(y ~ s(age, bs=\"cs\", k=8) +\n          s(sex, age, bs=\"sz\", k=8) +\n          s(Treatment, age, bs=\"sz\", k=8) + \n          s(subject_id, bs=\"re\"), \n        method=\"REML\",\n        data=.)\n}\n```\n:::\n\n\nAnd let's fit the simplest model (m2 - Treatment as an offset) and m5\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-46_793e5a7b8168c00814b6f7a8d777b99a'}\n\n```{.r .cell-code}\nm2Models <- map(brainstructs, m2)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n:::\n\n::: {.cell hash='index_cache/html/unnamed-chunk-47_31f81cb8976fd0cb0724153e8c393912'}\n\n```{.r .cell-code}\nm5Models <- map(brainstructs, m5)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n\nWarning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L =\nG$L, : Fitting terminated with step failure - check results carefully\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodelComp <- pmap(list(m2Models, m5Models, complexModel), function(a,b,c) anova(a,b,c,test=\"Chisq\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nm4g <- function(g1) {\n  emmeans(g1, ~ Treatment + sex|age, at=list(age=seq(3,65,1))) %>% tidy(conf.int=T)\n}\nm4gp <- function(g1) {\n  emmeans(g1, ~ Treatment + sex|age, at=list(age=seq(3,65,1))) %>% pairs(adjust=\"none\") %>% tidy(conf.int=T)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplotROI3 <- function(df, fittedModel, brainstructs, roiName, title=NULL, subtitle=NULL) {\n  df %>% \n  mutate(y=brainstructs[[roiName]]$volumes) %>% \n  ggplot() + \n  aes(x=age, y=y, colour=Treatment, fill=Treatment) + \n  geom_point(alpha=0.5) + \n  geom_ribbon(data=fittedModel, \n              aes(y=estimate, ymin=conf.low, ymax=conf.high), \n              colour=NA, alpha=0.5) + \n  geom_line(data=fittedModel, aes(y=estimate)) + \n  ylab(bquote(Volume ~ (mm^3))) + \n  ggtitle(ifelse(is.null(title), roiName, title), \n          subtitle = subtitle) +\n  scale_color_brewer(palette = \"Set1\") + \n  scale_fill_brewer(palette = \"Set1\") +\n    facet_grid(.~sex) +\n  theme_minimal()\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplotROI3(gf, m4g(complexModel[[\"corpus callosum\"]]), brainstructs, \"corpus callosum\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-51-1.png){width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}