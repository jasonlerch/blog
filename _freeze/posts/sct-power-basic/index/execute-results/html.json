{
  "hash": "eda4650ce582e0c707601bb90e5235d5",
  "result": {
    "markdown": "---\ntitle: \"SCT power analyses\"\ndescription: \"Understanding power for the SCT mouse model with some digressions into power in non-orthogonal designs\"\nauthor: \"Jason Lerch and Kamila Szulc-Lerch\"\ndate: \"2023-09-06\"\ndraft: false\ncategories: [R]\nformat:\n  html:\n    code-fold: true\n    code-summary: \"Show the code\"\n---\n\n\nThis posts originates from a power analysis needed for a grant application. But it brings with it some potentially interesting methods for conducting power analyses in general alongside some discussion of power in non-orthogonal designs.\n\n## Background\n\nThe power analyses here concern the [Sex Chromosome Trisomy (SCT) mouse model](https://bsd.biomedcentral.com/articles/10.1186/2042-6410-4-15), which separates gonadal from chromosomal sex and varies sex chromosome dosage. To do that, the testes forming *Sry* gene is deleted from the Y chromosome and reinserted onto an autosome, thus allowing one to have XX mice with testes or XY mice with ovaries. In addition, a supernumerary sex chromosome is added, giving one XXY and XYY mice in addition to the XY and XX animals. In the end, there are thus 8 genotypes in the SCT model, as summarized in the table below:\n\n| Shorthand | Gonads  | X dose | Y dose |\n|-----------|---------|--------|--------|\n| XYM       | Testes  | 1      | 1      |\n| XYF       | Ovaries | 1      | 1      |\n| XXM       | Testes  | 2      | 0      |\n| XXF       | Ovaries | 2      | 0      |\n| XXYM      | Testes  | 2      | 1      |\n| XXYF      | Ovaries | 2      | 1      |\n| XYYM      | Testes  | 1      | 2      |\n| XYYF      | Ovaries | 1      | 2      |\n\nThere are multiple ways to model this dataset, including testing for effects of 8 genotypes, the effect of aneuploidies, etc. But currently our thinking is that we can model the data as the effect of gonads, X chromosome dose, and Y chromosome dose.\n\n## Setting up the simulations\n\nLet's set up a function that can simulate this data. First, load some libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(ggplot2)\nlibrary(broom)\nlibrary(splines)\n```\n:::\n\n\nFor the sake of this post we'll keep it simple, and not look for any interactions, and assume that the effects (at least as simulated) are uncorrelated. We'll also look at what some large effect size (5 sd) simulations would look like to give us a sense of the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngenerateSCTData <- function(npergroup=10, \n                            gonadeffectmu=0,\n                            gonadeffectsd=0,\n                            xeffectmu=0,\n                            xeffectsd=0,\n                            yeffectmu=0,\n                            yeffectsd=0,\n                            epsilon=1) {\n  \n  # generate data from the normal distribution separately for each genotype. Here we just use\n  # epsilon for randomly distributed noise\n  groups <- rbind(data.frame(group=\"XYM\", gonad=1,X=1,Y=1, volume=rnorm(npergroup, 0, epsilon)),\n                  data.frame(group=\"XYF\", gonad=0,X=1,Y=1, volume=rnorm(npergroup, 0, epsilon)),\n                  data.frame(group=\"XXM\", gonad=1,X=2,Y=0, volume=rnorm(npergroup, 0, epsilon)),\n                  data.frame(group=\"XXF\", gonad=0,X=2,Y=0, volume=rnorm(npergroup, 0, epsilon)),\n                  data.frame(group=\"XXYM\",gonad=1,X=2,Y=1, volume=rnorm(npergroup, 0, epsilon)),\n                  data.frame(group=\"XXYF\",gonad=0,X=2,Y=1, volume=rnorm(npergroup, 0, epsilon)),\n                  data.frame(group=\"XYYM\",gonad=1,X=1,Y=2, volume=rnorm(npergroup, 0, epsilon)),\n                  data.frame(group=\"XYYF\",gonad=0,X=1,Y=2, volume=rnorm(npergroup, 0, epsilon))) \n  \n  # and now we add the effects, again normally distributed (only matters if the sd terms are non-zero)\n  groups$volume <- groups$volume + \n    rnorm(nrow(groups), gonadeffectmu * groups$gonad, gonadeffectsd) + \n    rnorm(nrow(groups), xeffectmu * groups$X, xeffectsd) + \n    rnorm(nrow(groups), yeffectmu * groups$Y, yeffectsd)\n    \n  # and return the dataset\n  return(groups %>% mutate(\n    gonadeffectmu=gonadeffectmu,\n    xeffectmu=xeffectmu,\n    yeffectmu=yeffectmu\n  ))\n  \n} \n\n# now generate three datasets with large effects\nSCTg <- generateSCTData(gonadeffectmu = 5) %>% mutate(sim=\"Beta gonads = 5\")\nSCTx <- generateSCTData(xeffectmu = 5) %>% mutate(sim=\"Beta X = 5\")\nSCTy <- generateSCTData(yeffectmu = 5) %>% mutate(sim=\"Beta Y = 5\")\n\nrbind(SCTg, SCTx, SCTy) %>% \n  ggplot() + \n  aes(x=group, y=volume) + \n  geom_boxplot() +\n  facet_grid(.~sim) + \n  theme_bw() +\n  theme(axis.text.x = element_text(angle = 45, hjust=1)) \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nThis makes a few points that come out of the model. Gonads are fully balanced, but chromosome dosage is not. There are two possible levels of X (1 and 2), and three of Y (0, 1, and 2). And there is some correlation between them\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngenerateSCTData(npergroup = 1) %>%\n  ggplot() + \n  aes(x=X, y=Y) + \n  geom_tile() + \n  xlab(\"X dose\") + \n  ylab(\"Y dose\") +\n  scale_x_continuous(breaks = c(1,2)) + \n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nThe design is not fully orthogonal - you cannot have an X dose of 1 and Y dose of 0, or and X dose of 2, and Y of 2.\n\n## SCT power\n\nWhat does the SCT model's non-orthogonal design do to our power? Let's see - we'll run a set of simulations. It'll be relatively straightforward:\n\n1.  for 500 simulations\n    1.  for effect sizes ranging from 0 to 1.5 with steps of 0.1\n\n        1.  simulate an SCT dataset of 10 subjects per genotype with one of the three terms (genotype, X dose, Y dose) varying by the effect size\n        2.  model it with y \\~ gonads + Xdose + Ydose\n        3.  assess the number of the simulations where p \\< 0.05\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-4_859f587726a2e59d73e55f9e3bc1c1df'}\n\n```{.r .cell-code}\ngenerateSCTSimSeries <- function(nsims=500,\n                                 npergroup=10,\n                                 gonadeffectmu=0,\n                                 xeffectmu=0,\n                                 yeffectmu=0,\n                                 epsilon=1){\n  # make sure that effects are all equal\n  if (length(gonadeffectmu) != length(xeffectmu) | \n      length(gonadeffectmu) != length(yeffectmu)) {\n    stop(\"Effects must be the same length\")\n  }\n  \n  neffects <- length(gonadeffectmu)\n  \n  # and now we run the simulations\n  return(pmap(list(npergroup=rep(npergroup, neffects*nsims), \n                       gonadeffectmu=rep(gonadeffectmu, nsims), \n                       xeffectmu=rep(xeffectmu, nsims), \n                       yeffectmu=rep(yeffectmu, nsims),\n                       epsilon=rep(epsilon, neffects*nsims)),\n                  generateSCTData))\n\n}\n\nmodelSCTSimSeries <- function(df) {\n  #df <- df %>% mutate(X = X-1)\n  tidy(lm(volume ~ gonad + X + Y, df)) %>% mutate(gonadeffectmu=df$gonadeffectmu[1],\n                                                  xeffectmu=df$xeffectmu[1],\n                                                  yeffectmu=df$yeffectmu[1]) %>%\n    pivot_wider(names_from = term, values_from = estimate:p.value)\n}\n\nmakePowerSeries <- function() {\n  effectseries <- seq(0, 1.5, 0.1)\n  neffects <- length(effectseries)\n  npergroup=10\n  nsims=500\n  \n  Gseries <- generateSCTSimSeries(nsims=nsims, npergroup = npergroup,\n                                     xeffect=rep(0, neffects), \n                                     yeffectmu = rep(0, neffects), \n                                     gonadeffectmu = effectseries) %>%\n    map_dfr(modelSCTSimSeries) %>% mutate(delta=gonadeffectmu, p=p.value_gonad)\n  Xseries <- generateSCTSimSeries(nsims=nsims, npergroup = npergroup,\n                                     gonadeffect=rep(0, neffects), \n                                     yeffectmu = rep(0, neffects), \n                                     xeffectmu = effectseries) %>%\n    map_dfr(modelSCTSimSeries) %>% mutate(delta=xeffectmu, p=p.value_X)\n  Yseries <- generateSCTSimSeries(nsims=nsims, npergroup = npergroup,\n                                     xeffect=rep(0, neffects), \n                                     gonadeffectmu = rep(0, neffects), \n                                     yeffectmu = effectseries) %>%\n    map_dfr(modelSCTSimSeries) %>% mutate(delta=yeffectmu, p=p.value_Y)\n  \n  allseries <- rbind(Gseries, Xseries, Yseries)\n  return(allseries)\n}\n\nfullseries <- makePowerSeries()\n```\n:::\n\n\nLet's see what this looks like:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfullseries %>% \n  group_by(yeffectmu, xeffectmu, gonadeffectmu) %>% \n  summarise(power=mean(p<0.05)) %>% \n  pivot_longer(yeffectmu:gonadeffectmu) %>% \n  ggplot() + \n  aes(x=value, y=power, colour=name) + \n  geom_point() + \n  geom_smooth(se=F, method=\"lm\", formula=y~ns(x,7)) + \n  xlab(bquote(delta ~ (effect ~ size))) + \n  scale_x_continuous(limits=c(0.05, 1.5)) + \n  scale_color_brewer(\"Model term\", labels=c(\"Gonad\", \"X dose\", \"Y dose\"), palette = \"Set1\") + \n  geom_hline(yintercept = 0.8) + \n  scale_y_continuous(breaks = seq(0,1,0.2)) + \n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nHere power - the proportion of simulations where p was \\< 0.05 - is on the y axis, and the simulated effect size on the x axis. So, for example, to get a power of 0.08 you'd need to an effect size of about 0.6 for gonads and Y dose and 0.9 for X dose.\n\n## Why is X dose less powered than Y or gonads?\n\nWhat's up with the previous results? Why is X dose at a lower power than Y or gonads?\n\nLet's start with gonads and test whether our simulations make sense. We simulated 10 mice per group, so given that exactly half the mice will be of each gonad type we can assess whether we'd get the same answer with a parametric power test:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npower.t.test(n=40, power=0.8)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n     Two-sample t test power calculation \n\n              n = 40\n          delta = 0.634299\n             sd = 1\n      sig.level = 0.05\n          power = 0.8\n    alternative = two.sided\n\nNOTE: n is number in *each* group\n```\n:::\n:::\n\n\nAnd indeed, the answer is the same - at 40 mice per group and a power of 0.8 you'd recapture an effect size of 0.63.\n\nBut you also have 40 mice with one X chromosome and 40 mice with 2 X chromosomes, yet the power is lower than expected. The answer lies in the fact that the two are correlated:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngenerateSCTData(npergroup = 1) %>% select(gonad, X, Y) %>% cor\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      gonad          X          Y\ngonad     1  0.0000000  0.0000000\nX         0  1.0000000 -0.7071068\nY         0 -0.7071068  1.0000000\n```\n:::\n:::\n\n\nNow go and have a read of [this paper from 1991](https://cdr.lib.unc.edu/downloads/028715161). Estimated errors in linear models are both dependent on the covariance between terms as well as the range of possible values. So X and Y doses are correlated, but Y dose has a greater range, hence the greater power for Y dose than X dose in the SCT model.\n\n## The dangers of model misspecification\n\nSo if there is a problem with colinearity why don't we run a separate model with just or X or Y dose? Let's try that for a single simulation of an effect size of 2 for X\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(42)\nXsim <- generateSCTData(xeffectmu = 2)\n```\n:::\n\n\nAnd let's look at the output of our linear model including all terms:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lm(volume ~ gonad + X + Y, Xsim))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = volume ~ gonad + X + Y, data = Xsim)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-2.71496 -0.56202  0.06254  0.65473  2.37194 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept) -0.01185    0.71272  -0.017   0.9868    \ngonad        0.40373    0.23757   1.699   0.0933 .  \nX            1.80717    0.33598   5.379 7.99e-07 ***\nY            0.11938    0.23757   0.503   0.6168    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 1.062 on 76 degrees of freedom\nMultiple R-squared:  0.4136,\tAdjusted R-squared:  0.3905 \nF-statistic: 17.87 on 3 and 76 DF,  p-value: 7.13e-09\n```\n:::\n:::\n\n\nLooks reasonably good in terms of both effect size and significance for both X and Y. But now let's just model X.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lm(volume ~ X, Xsim))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = volume ~ X, data = Xsim)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-2.8571 -0.6050  0.1795  0.6668  2.1104 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)   0.4885     0.3784   1.291    0.201    \nX             1.6878     0.2393   7.053 6.25e-10 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 1.07 on 78 degrees of freedom\nMultiple R-squared:  0.3894,\tAdjusted R-squared:  0.3816 \nF-statistic: 49.74 on 1 and 78 DF,  p-value: 6.247e-10\n```\n:::\n:::\n\n\nThe estimate is a bit lower, but still not too far off. But let's model Y for data where only a change in X was simulated:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lm(volume ~ Y, Xsim))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = volume ~ Y, data = Xsim)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-3.6766 -0.8249  0.2119  0.9249  2.5556 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)   3.8044     0.2419   15.73  < 2e-16 ***\nY            -0.7842     0.1975   -3.97 0.000159 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 1.249 on 78 degrees of freedom\nMultiple R-squared:  0.1681,\tAdjusted R-squared:  0.1575 \nF-statistic: 15.76 on 1 and 78 DF,  p-value: 0.0001585\n```\n:::\n:::\n\n\nA woefully incorrect estimate. In the presence of colinearity you need to covary for the other parameters to not get caught in a badly misspecified model.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}